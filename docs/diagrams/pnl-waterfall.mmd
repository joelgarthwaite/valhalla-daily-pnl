%% Valhalla Hub - P&L Waterfall Calculation Flow
%% Render with: https://mermaid.live or VS Code Mermaid extension

flowchart TB
    subgraph Revenue["Revenue Sources"]
        SHOPIFY_REV["Shopify Revenue<br/>subtotal_price"]
        ETSY_REV["Etsy Revenue<br/>subtotal"]
        B2B_REV["B2B Revenue<br/>Manual entry"]
    end

    subgraph GrossRev["Gross Revenue Calculation"]
        PRODUCT_REV["Product Revenue<br/>= Shopify + Etsy + B2B<br/>(excludes shipping & tax)"]
        REFUNDS["Refunds<br/>From raw_data"]
        NET_REV["Net Revenue<br/>= Product Revenue - Refunds"]
    end

    subgraph GP1_Calc["GP1: Gross Profit 1"]
        COGS["COGS<br/>30% of Net Revenue<br/>(configurable per brand)"]
        GP1["GP1<br/>= Net Revenue - COGS<br/>'Gross profit after cost of goods'"]
    end

    subgraph GP2_Calc["GP2: Gross Profit 2"]
        PICK_PACK["Pick & Pack<br/>5% of Revenue"]
        SHOPIFY_FEES["Shopify Fees<br/>2.9% + £0.30/txn"]
        ETSY_FEES["Etsy Fees<br/>6.5%"]
        LOGISTICS["Logistics<br/>3% of Revenue"]
        GP2["GP2<br/>= GP1 - Pick&Pack - Fees - Logistics<br/>'Operating profit after fulfillment'"]
    end

    subgraph GP3_Calc["GP3: Contribution Margin"]
        META_SPEND["Meta Ad Spend<br/>From Marketing API"]
        GOOGLE_SPEND["Google Ad Spend<br/>From Ads API"]
        MANUAL_SPEND["Manual Ad Spend<br/>Admin entry"]
        TOTAL_ADS["Total Ad Spend"]
        GP3["GP3<br/>= GP2 - Total Ad Spend<br/>'Profit after advertising'"]
    end

    subgraph NetProfit["True Net Profit"]
        STAFF["Staff<br/>Salaries, NI, pensions"]
        PREMISES["Premises<br/>Rent, utilities"]
        SOFTWARE["Software<br/>Subscriptions"]
        OTHER_OPEX["Other OPEX<br/>Professional, insurance, etc."]
        TOTAL_OPEX["Total OPEX<br/>(pro-rated daily)"]
        TRUE_NET["True Net Profit<br/>= GP3 - OPEX<br/>'THE BOTTOM LINE'"]
    end

    subgraph Metrics["Key Metrics"]
        NET_MARGIN["Net Margin %<br/>= True Net Profit / Net Revenue × 100<br/>Target: >15%"]
        POAS["POAS<br/>= GP3 / Ad Spend × 100<br/>200% = £2 profit per £1 spend"]
        MER["MER<br/>= Revenue / Ad Spend<br/>Marketing Efficiency Ratio"]
        AOV["AOV<br/>= Revenue / Orders<br/>Average Order Value"]
    end

    %% Flow connections
    SHOPIFY_REV --> PRODUCT_REV
    ETSY_REV --> PRODUCT_REV
    B2B_REV --> PRODUCT_REV
    PRODUCT_REV --> NET_REV
    REFUNDS --> NET_REV

    NET_REV --> COGS
    COGS --> GP1
    NET_REV --> GP1

    GP1 --> GP2
    PICK_PACK --> GP2
    SHOPIFY_FEES --> GP2
    ETSY_FEES --> GP2
    LOGISTICS --> GP2

    GP2 --> GP3
    META_SPEND --> TOTAL_ADS
    GOOGLE_SPEND --> TOTAL_ADS
    MANUAL_SPEND --> TOTAL_ADS
    TOTAL_ADS --> GP3

    GP3 --> TRUE_NET
    STAFF --> TOTAL_OPEX
    PREMISES --> TOTAL_OPEX
    SOFTWARE --> TOTAL_OPEX
    OTHER_OPEX --> TOTAL_OPEX
    TOTAL_OPEX --> TRUE_NET

    TRUE_NET --> NET_MARGIN
    GP3 --> POAS
    TOTAL_ADS --> POAS
    NET_REV --> MER
    TOTAL_ADS --> MER
    NET_REV --> AOV

    %% Styling
    classDef revenue fill:#c8e6c9,stroke:#2e7d32
    classDef cost fill:#ffcdd2,stroke:#c62828
    classDef profit fill:#bbdefb,stroke:#1565c0
    classDef metric fill:#fff9c4,stroke:#f9a825

    class SHOPIFY_REV,ETSY_REV,B2B_REV,PRODUCT_REV,NET_REV revenue
    class COGS,PICK_PACK,SHOPIFY_FEES,ETSY_FEES,LOGISTICS,META_SPEND,GOOGLE_SPEND,MANUAL_SPEND,TOTAL_ADS,STAFF,PREMISES,SOFTWARE,OTHER_OPEX,TOTAL_OPEX,REFUNDS cost
    class GP1,GP2,GP3,TRUE_NET profit
    class NET_MARGIN,POAS,MER,AOV metric
